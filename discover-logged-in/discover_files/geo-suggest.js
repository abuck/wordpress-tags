var GeoSuggest=function(options){var options=options||{},attribution=options.attribution||jQuery('#attribution'),widgetContainer=options.widgetContainer||jQuery('.geo-form'),searchInput=options.searchInput||jQuery('#searchinput'),latInput=options.latInput||jQuery('#lat'),lonInput=options.lonInput||jQuery('#lon'),placeReferenceInput=options.placeReferenceInput||null,geoResults=options.geoResults||jQuery('#results'),allContainer=options.allContainer||options.geoResults||jQuery('#results'),lastSelected=options.lastSelected||{name:searchInput.val(),lat:latInput.val(),lon:lonInput.val(),placeReference:placeReferenceInput?placeReferenceInput.val():null},selectedNode=allContainer.find('li').first(),afterSearchCallback=options.afterSearchCallback||function(){},afterDetailsCallback=options.afterDetailsCallback||function(){},service=new google.maps.places.AutocompleteService(),detailsService=new google.maps.places.PlacesService(attribution[0]),placeHolderSupported=('placeholder'in document.createElement('input')),that=this,isSelected=false,lastQuery=searchInput.data('last-query'),allResults;var searchCallback=function(predictions,status){var resultStr='';if(google.maps.places.PlacesServiceStatus.OK!=status)return;for(var i=0,prediction;prediction=predictions[i];i++){resultStr+='<li data-geoid="'+prediction.reference+'">'+prediction.description+'</li>';}
geoResults.html(resultStr);allResults=allContainer.find('li');selectedNode=allResults.first();selectedNode.addClass('selected');geoResults.show();afterSearchCallback(predictions);};var detailsCallback=function(place,status){if(google.maps.places.PlacesServiceStatus.OK!=status)return;var lat=place.geometry.location.lat(),lon=place.geometry.location.lng(),placeReference=place.reference,name=searchInput.val();latInput.val(lat);lonInput.val(lon);if(placeReferenceInput)placeReferenceInput.val(placeReference);lastSelected={name:name,lat:lat,lon:lon,placeReference:placeReference};widgetContainer.addClass('geo-selected');allContainer.hide();afterDetailsCallback(place);};var iterateSelected=function(direction){var selected,newSelected,node;for(var i=0;i<allResults.length;i++){node=jQuery(allResults[i]);if(node.hasClass('selected')){selected=i;node.removeClass('selected');}}
newSelected=selected+direction;if(newSelected>=allResults.length)newSelected=selected;if(newSelected<0)newSelected=0;selectedNode=jQuery(allResults[newSelected]);selectedNode.addClass('selected');};searchInput.keydown(function(e){if(38==e.keyCode){e.preventDefault();iterateSelected(-1);}
else if(40==e.keyCode){e.preventDefault();iterateSelected(1);}
else if(13==e.keyCode){e.preventDefault();selectedNode.click();searchInput.blur();}
else if(27==e.keyCode){e.preventDefault();lastQuery='';geoResults.empty();searchInput.blur();}});searchInput.keyup(function(e){if(13==e.keyCode||27==e.keyCode||38==e.keyCode||40==e.keyCode)return;var searchVal=searchInput.val(),searchQuery={input:searchVal,types:['(cities)']};lastQuery=searchVal;if(searchVal.length<3){geoResults.empty();return;}
service.getPlacePredictions(searchQuery,searchCallback);});searchInput.focus(function(e){isSelected=false;searchInput.val(lastQuery);allContainer.show();});searchInput.blur(function(e){setTimeout(function(){allContainer.hide();if(isSelected)return;that.revertToLast();},150);});geoResults.delegate('li','click',function(e){isSelected=true;var geoItem=jQuery(e.target),geoReference=geoItem.data('geoid');searchInput.val(geoItem.text());detailsService.getDetails({reference:geoReference},detailsCallback);});allContainer.delegate('li','hover',function(e){selectedNode.removeClass('selected');selectedNode=jQuery(e.target);selectedNode.addClass('selected');});this.clearGeo=function(){latInput.val('');lonInput.val('');if(placeReferenceInput)placeReferenceInput.val('');placeholder=placeHolderSupported?'':searchInput.attr('placeholder');searchInput.val(placeholder);widgetContainer.removeClass('geo-selected');isSelected=false;};this.setGeo=function(opts){var opts=opts||{},lat=opts.lat||'',lon=opts.lon||'',placeReference=opts.placeReference||'',name=opts.name||'';isSelected=true;lastSelected=opts;latInput.val(lat);lonInput.val(lon);if(placeReferenceInput)placeReferenceInput.val(placeReference);searchInput.val(name);widgetContainer.addClass('geo-selected');allContainer.hide();};this.revertToLast=function(){that.setGeo(lastSelected);afterDetailsCallback();};this.getPlaceForLatLon=function(lat_lon,onLocated){var self=this,lat_lon=lat_lon.split(','),onLocated=onLocated||function(place){},request={location:new google.maps.LatLng(parseFloat(lat_lon[0]),parseFloat(lat_lon[1])),radius:500,types:['locality','administrative_area_level_3']},processLatLonPlace=function(results,status){if(google.maps.places.PlacesServiceStatus.OK!=status){onLocated('Nearby Locations');return;}
self.getPlaceNameForGoogleReference(results[0].reference,onLocated);};detailsService.nearbySearch(request,processLatLonPlace);};this.getPlaceNameForGoogleReference=function(reference,onLocated){var onLocated=onLocated||function(place){},request={reference:reference},processPlace=function(result,status){if(google.maps.places.PlacesServiceStatus.OK!=status){onLocated('Nearby Locations');return;}
onLocated(result.formatted_address);};detailsService.getDetails(request,processPlace);};};